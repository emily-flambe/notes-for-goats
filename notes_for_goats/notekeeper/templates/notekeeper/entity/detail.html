{% extends "notekeeper/base.html" %}

{% block title %}{{ entity.name }}{% endblock %}

{% block content %}
<h1>{{ entity.name }} <small>({{ entity.get_type_display }})</small></h1>

<div class="entity-notes">
    <h2>Notes</h2>
    {% if entity.notes %}
        {{ entity.notes|linebreaks }}
    {% else %}
        <p>No notes for this entity.</p>
    {% endif %}
</div>

<div class="related-entries">
    <h2>Related Journal Entries</h2>
    {% if related_entries %}
        <ul>
        {% for entry in related_entries %}
            <li>
                <a href="{% url 'notekeeper:journal_detail' workspace_id=workspace.id pk=entry.pk %}">
                    <strong>{{ entry.timestamp|date:"Y-m-d H:i" }}</strong>: {{ entry.title }}
                </a>
            </li>
        {% endfor %}
        </ul>
    {% else %}
        <p>No related journal entries.</p>
    {% endif %}
</div>

<div class="relationships-section">
    <h3>Relationships</h3>
    
    {% if entity_relationships %}
        <div class="relationships-list">
            <table class="table" id="relationships-table">
                <thead>
                    <tr>
                        <th class="sortable" data-column="type">Type <span class="sort-icon">↕</span></th>
                        <th class="sortable" data-column="entity">Related Entity <span class="sort-icon">↕</span></th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rel, related_entity, is_source in entity_relationships %}
                        <tr>
                            <td data-sort-value="{{ rel.relationship_type.display_name|lower }}">
                                {% if is_source %}
                                    {{ rel.relationship_type.display_name }}
                                {% else %}
                                    {% if rel.relationship_type.inverse_name %}
                                        {{ rel.relationship_type.inverse_name }}
                                    {% else %}
                                        {{ rel.relationship_type.display_name }}
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td data-sort-value="{{ related_entity.name|lower }}">
                                {% if related_entity.id %}
                                    <a href="{% url 'notekeeper:entity_detail' workspace_id=workspace.id pk=related_entity.id %}">
                                        {{ related_entity.name }}
                                    </a>
                                    {% if related_entity.get_type_display %}
                                        <span class="entity-type-badge">{{ related_entity.get_type_display }}</span>
                                    {% endif %}
                                {% else %}
                                    {{ related_entity }}
                                {% endif %}
                            </td>
                            <td>{{ rel.notes|truncatechars:50|default:"-" }}</td>
                            <td class="actions">
                                <a href="{% url 'notekeeper:relationship_edit' workspace_id=workspace.id pk=rel.id %}" class="btn btn-sm">Edit</a>
                                <a href="{% url 'notekeeper:relationship_delete' workspace_id=workspace.id pk=rel.id %}?from_entity={{ entity.id }}" class="btn btn-sm btn-danger">Delete</a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p class="no-relationships">No relationships defined for this entity.</p>
    {% endif %}
    
    <div class="relationship-actions">
        <a href="{% url 'notekeeper:relationship_create' workspace_id=workspace.id %}?source_type=entity&source_id={{ entity.id }}" class="btn btn-sm">Add Relationship</a>
        {% if entity_relationships %}
            <a href="{% url 'notekeeper:entity_relationships_graph' workspace_id=workspace.id pk=entity.id %}" class="btn btn-sm">View Relationship Graph</a>
        {% endif %}
    </div>
</div>

<div class="actions">
    <a href="{% url 'notekeeper:entity_edit' workspace_id=workspace.id pk=entity.pk %}" class="btn">Edit</a>
    <a href="{% url 'notekeeper:entity_list' workspace_id=workspace.id %}" class="btn">Back to Entities</a>
</div>

<style>
    .relationships-section {
        margin-top: 30px;
        border-top: 1px solid #e2e8f0;
        padding-top: 20px;
    }
    .relationships-section h3 {
        margin-bottom: 15px;
    }
    .relationships-list {
        margin-top: 15px;
        margin-bottom: 20px;
    }
    .no-relationships {
        color: #718096;
        font-style: italic;
    }
    .relationship-actions {
        margin-top: 15px;
    }
    .entity-type-badge {
        display: inline-block;
        font-size: 0.75rem;
        padding: 2px 8px;
        border-radius: 10px;
        background-color: #edf2f7;
        color: #4a5568;
        margin-left: 8px;
    }
    td.actions {
        white-space: nowrap;
    }
    
    th.sortable {
        cursor: pointer;
        position: relative;
        user-select: none;
    }
    
    th.sortable:hover {
        background-color: #f8f9fa;
    }
    
    .sort-icon {
        font-size: 0.8em;
        margin-left: 5px;
        color: #aaa;
    }
    
    th.sorted-asc .sort-icon {
        content: "↑";
        color: #333;
    }
    
    th.sorted-desc .sort-icon {
        content: "↓";
        color: #333;
    }
    
    th.sorted-asc .sort-icon:after {
        content: "↑";
    }
    
    th.sorted-desc .sort-icon:after {
        content: "↓";
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const table = document.getElementById('relationships-table');
        if (!table) return;
        
        const sortableHeaders = table.querySelectorAll('th.sortable');
        
        sortableHeaders.forEach(header => {
            header.addEventListener('click', function() {
                const column = this.getAttribute('data-column');
                const isAscending = !this.classList.contains('sorted-asc');
                
                sortableHeaders.forEach(h => {
                    h.classList.remove('sorted-asc', 'sorted-desc');
                });
                
                this.classList.add(isAscending ? 'sorted-asc' : 'sorted-desc');
                
                this.querySelector('.sort-icon').textContent = isAscending ? '↑' : '↓';
                
                const tbody = table.querySelector('tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                
                rows.sort((a, b) => {
                    let cellIndex = column === 'type' ? 0 : 1;
                    
                    const aValue = a.querySelectorAll('td')[cellIndex].getAttribute('data-sort-value') || 
                                  a.querySelectorAll('td')[cellIndex].textContent.trim().toLowerCase();
                    const bValue = b.querySelectorAll('td')[cellIndex].getAttribute('data-sort-value') || 
                                  b.querySelectorAll('td')[cellIndex].textContent.trim().toLowerCase();
                    
                    if (aValue < bValue) return isAscending ? -1 : 1;
                    if (aValue > bValue) return isAscending ? 1 : -1;
                    return 0;
                });
                
                while (tbody.firstChild) {
                    tbody.removeChild(tbody.firstChild);
                }
                
                rows.forEach(row => {
                    tbody.appendChild(row);
                });
            });
        });
    });
</script>
{% endblock %} 